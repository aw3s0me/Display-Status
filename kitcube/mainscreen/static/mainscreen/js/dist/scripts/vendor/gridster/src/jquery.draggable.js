/*
 * jquery.draggable
 * https://github.com/ducksboard/gridster.js
 *
 * Copyright (c) 2012 ducksboard
 * Licensed under the MIT licenses.
 */

(function(e,t,n,r){function l(t,r){this.options=e.extend({},i,r),this.$body=e(n.body),this.$container=e(t),this.$dragitems=e(this.options.items,this.$container),this.is_dragging=!1,this.player_min_left=0+this.options.offset_left,this.init()}var i={items:"li",distance:1,limit:!0,offset_left:0,autoscroll:!0,ignore_dragging:["INPUT","TEXTAREA","SELECT","BUTTON"],handle:null,container_width:0,move_element:!0,helper:!1},s=e(t),o={x:"left",y:"top"},u="ontouchstart"in t,a={start:u?"touchstart.gridster-draggable":"mousedown.gridster-draggable",move:u?"touchmove.gridster-draggable":"mousemove.gridster-draggable",end:u?"touchend.gridster-draggable":"mouseup.gridster-draggable"},f=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},c=l.prototype;c.init=function(){var n=this.$container.css("position");this.calculate_dimensions(),this.$container.css("position",n==="static"?"relative":n),this.disabled=!1,this.events(),e(t).bind("resize.gridster-draggable",throttle(e.proxy(this.calculate_dimensions,this),200))},c.events=function(){this.$container.on("selectstart.gridster-draggable",e.proxy(this.on_select_start,this)),this.$container.on(a.start,this.options.items,e.proxy(this.drag_handler,this)),this.$body.on(a.end,e.proxy(function(e){this.is_dragging=!1;if(this.disabled)return;this.$body.off(a.move),this.drag_start&&this.on_dragstop(e)},this))},c.get_actual_pos=function(e){var t=e.position();return t},c.get_mouse_pos=function(e){if(u){var t=e.originalEvent;e=t.touches.length?t.touches[0]:t.changedTouches[0]}return{left:e.clientX,top:e.clientY}},c.get_offset=function(e){e.preventDefault();var t=this.get_mouse_pos(e),n=Math.round(t.left-this.mouse_init_pos.left),r=Math.round(t.top-this.mouse_init_pos.top),i=Math.round(this.el_init_offset.left+n-this.baseX+this.scroll_offset_x),s=Math.round(this.el_init_offset.top+r-this.baseY+this.scroll_offset_y);return this.options.limit&&(i>this.player_max_left?i=this.player_max_left:i<this.player_min_left&&(i=this.player_min_left)),{position:{left:i,top:s},pointer:{left:t.left,top:t.top,diff_left:n+this.scroll_offset_x,diff_top:r+this.scroll_offset_y}}},c.get_drag_data=function(e){var t=this.get_offset(e);return t.$player=this.$player,t.$helper=this.helper?this.$helper:this.$player,t},c.set_limits=function(e){return e||(e=this.$container.width()),this.player_max_left=e-this.player_width+ -this.options.offset_left,this.options.container_width=e,this},c.scroll_in=function(t,r){var i=o[t],u=50,a=30,l=t==="x",c=l?this.window_width:this.window_height,h=l?e(n).width():e(n).height(),p=l?this.$player.width():this.$player.height(),d,v=s["scroll"+f(i)](),m=v,g=m+c,y=g-u,b=m+u,w=m+r.pointer[i],E=h-c+p;return w>=y&&(d=v+a,d<E&&(s["scroll"+f(i)](d),this["scroll_offset_"+t]+=a)),w<=b&&(d=v-a,d>0&&(s["scroll"+f(i)](d),this["scroll_offset_"+t]-=a)),this},c.manage_scroll=function(e){this.scroll_in("x",e),this.scroll_in("y",e)},c.calculate_dimensions=function(e){this.window_height=s.height(),this.window_width=s.width()},c.drag_handler=function(t){var n=t.target.nodeName;if(this.disabled||t.which!==1&&!u)return;if(this.ignore_drag(t))return;var r=this,i=!0;this.$player=e(t.currentTarget),this.el_init_pos=this.get_actual_pos(this.$player),this.mouse_init_pos=this.get_mouse_pos(t),this.offsetY=this.mouse_init_pos.top-this.el_init_pos.top,this.$body.on(a.move,function(e){var t=r.get_mouse_pos(e),n=Math.abs(t.left-r.mouse_init_pos.left),s=Math.abs(t.top-r.mouse_init_pos.top);return n>r.options.distance||s>r.options.distance?i?(i=!1,r.on_dragstart.call(r,e),!1):(r.is_dragging===!0&&r.on_dragmove.call(r,e),!1):!1});if(!u)return!1},c.on_dragstart=function(e){e.preventDefault();if(this.is_dragging)return this;this.drag_start=this.is_dragging=!0;var t=this.$container.offset();return this.baseX=Math.round(t.left),this.baseY=Math.round(t.top),this.initial_container_width=this.options.container_width||this.$container.width(),this.options.helper==="clone"?(this.$helper=this.$player.clone().appendTo(this.$container).addClass("helper"),this.helper=!0):this.helper=!1,this.scroll_offset_y=0,this.scroll_offset_x=0,this.el_init_offset=this.$player.offset(),this.player_width=this.$player.width(),this.player_height=this.$player.height(),this.set_limits(this.options.container_width),this.options.start&&this.options.start.call(this.$player,e,this.get_drag_data(e)),!1},c.on_dragmove=function(e){var t=this.get_drag_data(e);this.options.autoscroll&&this.manage_scroll(t),this.options.move_element&&(this.helper?this.$helper:this.$player).css({position:"absolute",left:t.position.left,top:t.position.top});var n=this.last_position||t.position;return t.prev_position=n,this.options.drag&&this.options.drag.call(this.$player,e,t),this.last_position=t.position,!1},c.on_dragstop=function(e){var t=this.get_drag_data(e);return this.drag_start=!1,this.options.stop&&this.options.stop.call(this.$player,e,t),this.helper&&this.$helper.remove(),!1},c.on_select_start=function(e){if(this.disabled)return;if(this.ignore_drag(e))return;return!1},c.enable=function(){this.disabled=!1},c.disable=function(){this.disabled=!0},c.destroy=function(){this.disable(),this.$container.off(".gridster-draggable"),this.$body.off(".gridster-draggable"),e(t).off(".gridster-draggable"),e.removeData(this.$container,"drag")},c.ignore_drag=function(t){return this.options.handle?!e(t.target).is(this.options.handle):e(t.target).is(this.options.ignore_dragging.join(", "))},e.fn.drag=function(e){return new l(this,e)}})(jQuery,window,document);