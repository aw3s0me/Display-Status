/*!
 * async.js
 * Copyright(c) 2010 Fabian Jakobs <fabian.jakobs@web.de>
 * MIT Licensed
 */

define(["require","exports","module"],function(e,t,n){var r=t.STOP={};t.Generator=function(e){typeof e=="function"?this.source={next:e}:this.source=e},function(){this.next=function(e){this.source.next(e)},this.map=function(e){if(!e)return this;e=i(1,e);var t=this.source;return this.next=function(n){t.next(function(t,r){t?n(t):e(r,function(e,t){e?n(e):n(null,t)})})},new this.constructor(this)},this.filter=function(e){if(!e)return this;e=i(1,e);var t=this.source;return this.next=function(n){t.next(function r(i,s){i?n(i):e(s,function(e,i){e?n(e):i?n(null,s):t.next(r)})})},new this.constructor(this)},this.slice=function(e,t){var n=-1;if(!t||t<0)var t=Infinity;var i=this.source;return this.next=function(s){i.next(function o(u,a){n++,u?s(u):n>=e&&n<t?s(null,a):n>=t?s(r):i.next(o)})},new this.constructor(this)},this.reduce=function(e,t){e=i(3,e);var n=0,s=!1,o=t,u=this.source;return this.next=function(i){function a(){u.next(function t(a,f){if(a)return s=!0,a==r?i(null,o):a;e(o,f,n++,function(e,n){o=n,u.next(t)})})}if(s)return i(r);t===undefined?u.next(function(e,t){if(e)return i(e,o);o=t,a()}):a()},new this.constructor(this)},this.forEach=this.each=function(e){e=i(1,e);var t=this.source;return this.next=function(n){t.next(function(r,i){r?n(r):e(i,function(e){n(e,i)})})},new this.constructor(this)},this.some=function(e){e=i(1,e);var t=this.source,n=!1;return this.next=function(i){if(n)return i(r);t.next(function s(o,u){if(o)return i(o);e(u,function(e,o){e?(n=!0,e==r?i(null,!1):i(e)):o?(n=!0,i(null,!0)):t.next(s)})})},new this.constructor(this)},this.every=function(e){e=i(1,e);var t=this.source,n=!1;return this.next=function(i){if(n)return i(r);t.next(function s(o,u){if(o)return i(o);e(u,function(e,o){e?(n=!0,e==r?i(null,!0):i(e)):o?t.next(s):(n=!0,i(null,!1))})})},new this.constructor(this)},this.call=function(e){var t=this.source;return this.map(function(t,n){t=i(0,t,e),t.call(e,function(e,t){n(e,t)})})},this.concat=function(e){var t=[this];t.push.apply(t,arguments);var n=0,i=t[n++];return new this.constructor(function(e){i.next(function s(o,u){return o?o==r?(i=t[n++],i?i.next(s):e(r)):e(o):e(null,u)})})},this.zip=function(e){var n=[this];return n.push.apply(n,arguments),new this.constructor(function(e){t.list(n).map(function(e,t){e.next(t)}).toArray(e)})},this.expand=function(e,t){if(!e)return this;var e=i(1,e),t=t||this.constructor,n=this.source,s=null;return new t(function o(t){s?s.next(function(e,n){if(e==r)return s=null,o(t);if(e)return t(e);t(e,n)}):n.next(function(n,r){if(n)return t(n);e(r,function(e,n){if(e)return t(e);s=n,o(t)})})})},this.sort=function(e){var n=this,r;return this.next=function(i){if(r)return r.next(i);n.toArray(function(n,s){n?i(n):(r=t.list(s.sort(e)),r.next(i))})},new this.constructor(this)},this.join=function(e){return this.$arrayOp(Array.prototype.join,e!==undefined?[e]:null)},this.reverse=function(){return this.$arrayOp(Array.prototype.reverse)},this.$arrayOp=function(e,t){var n=this,i=0;return this.next=function(s){if(i++>0)return s(r);n.toArray(function(n,r){n?s(n,""):t?s(null,e.apply(r,t)):s(null,e.call(r))})},new this.constructor(this)},this.end=function(e,t){t||(t=arguments[0],e=!0);var n=this.source,i,s;n.next(function o(u,a){u?u==r?t&&t(s,i):e?t&&t(u,a):(s=u,n.next(o)):(i=a,n.next(o))})},this.toArray=function(e,t){t||(t=arguments[0],e=!0);var n=[],i=[],s=this.source;s.next(function o(u,a){if(u){if(u==r)return e?t(null,n):(i.length=n.length,t(i,n));if(e)return t(u);i[n.length]=u}n.push(a),s.next(o)})}}.call(t.Generator.prototype);var i=t.makeAsync=function(e,t,n){return t.length>e?t:function(){var r,i=arguments[e];try{r=t.apply(n||this,arguments)}catch(s){return i(s)}i(null,r)}};t.list=function(e,n){var n=n||t.Generator,i=0,s=e.length;return new n(function(t){i<s?t(null,e[i++]):t(r)})},t.values=function(e,n){var r=[];for(var i in e)r.push(e[i]);return t.list(r,n)},t.keys=function(e,n){var r=[];for(var i in e)r.push(i);return t.list(r,n)},t.range=function(e,n,i,s){var s=s||t.Generator;e=e||0,i=i||1;if(n===undefined||n===null)n=i>0?Infinity:-Infinity;var o=e;return new s(function(e){if(i>0&&o>=n||i<0&&o<=n)e(r);else{var t=o;o+=i,e(null,t)}})},t.concat=function(e,t){return arguments.length>1?e.concat.apply(e,Array.prototype.slice.call(arguments,1)):e},t.zip=function(e,t){return arguments.length>1?e.zip.apply(e,Array.prototype.slice.call(arguments,1)):e.map(function(e,t){t(null,[e])})},t.plugin=function(e,n){if(e)for(var r in e)t.Generator.prototype[r]=e[r];if(n)for(var r in n)t[r]=n[r]}});