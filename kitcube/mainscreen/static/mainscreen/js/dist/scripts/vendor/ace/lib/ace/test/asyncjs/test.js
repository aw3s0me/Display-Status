/*!
 * async.js
 * Copyright(c) 2010 Fabian Jakobs <fabian.jakobs@web.de>
 * MIT Licensed
 */

define(["require","exports","module","ace/lib/oop","asyncjs/async","asyncjs/utils"],function(e,t,n){var r=e("ace/lib/oop"),i=e("asyncjs/async");e("asyncjs/utils"),t.TestGenerator=function(e){i.Generator.call(this,e)},r.inherits(t.TestGenerator,i.Generator),function(){this.exec=function(){this.run().report().summary(function(e,t){console.log("DONE")})},this.run=function(){return this.setupTest().each(function(e,t){e.setUpSuite?e.setUpSuite(t):t()}).each(function(e,t){e.test(function(n,r){e.err=n,e.passed=r,t()})}).each(function(e,t){e.tearDownSuite?e.tearDownSuite(t):t()})},this.report=function(){return this.each(function(e,t){var n=e.passed?"[32m":"[31m",r=e.name;e.suiteName&&(r=e.suiteName+": "+e.name),console.log(n+"["+e.count+"/"+e.index+"] "+r+" "+(e.passed?"OK":"FAIL")+"[0m"),e.passed||(e.err.stack?console.log(e.err.stack):console.log(e.err)),t()})},this.summary=function(e){var t=0,n=0;this.each(function(e){e.passed?t+=1:n+=1}).end(function(){console.log(""),console.log("Summary:"),console.log(""),console.log("Total number of tests: "+(t+n)),t&&console.log("[32mPassed tests:          "+t+"[0m"),n&&console.log("[31mFailed tests:          "+n+"[0m"),console.log(""),e(null,n==0)})},this.setupTest=function(){return this.each(function(e,t){function u(t){tearDownCalled=!0,o.call(e.context,t)}var n=function(e){e()},r=e.context||this;if(e.setUp)var s=i.makeAsync(0,e.setUp,r);else s=n;tearDownCalled=!1;if(e.tearDown)var o=i.makeAsync(0,e.tearDown,r);else o=n;var a=i.makeAsync(0,e.fn,r);e.test=function(t){function o(r){if(n)return;n=!0,tearDownCalled?t(r,!1):i.list([u]).call().timeout(e.timeout).end(function(){t(r,!1)})}var n;i.list([s,a,u]).delay(0).call(r).timeout(e.timeout).toArray(!1,function(e,r){if(n)return;n=!0;var i=e[1];t(i,!i)})},t()})}}.call(t.TestGenerator.prototype),t.testcase=function(e,n,r){var s=[];for(var o in e)s.push(o);var u=e.setUp||null,a=e.tearDown||null,f;s.forEach(function(e){e.charAt(0)==">"&&(f=e)}),f&&(s=[f]);var l=s.filter(function(t){return t.match(/^>?test/)&&typeof e[t]=="function"}),c=l.length,h=1;return tests=l.map(function(t){return{suiteName:n||e.name||"",name:t,setUp:u,tearDown:a,context:e,timeout:r===undefined?3e3:r,fn:e[t],count:c,index:h++}}),e.setUpSuite&&(tests[0].setUpSuite=i.makeAsync(0,e.setUpSuite,e)),e.tearDownSuite&&(tests[tests.length-1].tearDownSuite=i.makeAsync(0,e.tearDownSuite,e)),i.list(tests,t.TestGenerator)}});