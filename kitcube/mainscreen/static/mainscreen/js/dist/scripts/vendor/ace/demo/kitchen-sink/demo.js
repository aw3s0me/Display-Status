/* ***** BEGIN LICENSE BLOCK *****
 * Distributed under the BSD license:
 *
 * Copyright (c) 2010, Ajax.org B.V.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of Ajax.org B.V. nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * ***** END LICENSE BLOCK ***** */

define(["require","exports","module","ace/lib/fixoldbrowsers","ace/multi_select","ace/ext/spellcheck","./inline_editor","./dev_util","./file_drop","ace/config","ace/lib/dom","ace/lib/net","ace/lib/lang","ace/lib/useragent","ace/lib/event","ace/theme/textmate","ace/edit_session","ace/undomanager","ace/keyboard/hash_handler","ace/virtual_renderer","ace/editor","ace/ext/whitespace","./doclist","ace/ext/modelist","ace/ext/themelist","./layout","./token_tooltip","./util","ace/ext/elastic_tabstops_lite","ace/incremental_search","ace/worker/worker_client","ace/split","ace/keyboard/vim","ace/ext/statusbar","ace/ext/emmet","ace/snippets","ace/ext/language_tools"],function(e,t,n){function F(){var e=i.split.$container.offsetLeft,t=document.documentElement.clientWidth-e;O.style.width=t+"px",O.style.height=document.documentElement.clientHeight-j+"px",i.split.resize(),D.style.width=t+"px",P.resize()}function nt(){var e=i.editor,t=e.session;t.setFoldStyle(z.value),x(I,t.name),x(q,t.modeName||"text"),x(R,t.getUseWrapMode()?t.getWrapLimitRange().min||"free":"off"),x(W,e.getSelectionStyle()=="line"),x(U,e.getTheme()),x(X,e.getHighlightActiveLine()),x(V,e.getShowInvisibles()),x($,e.renderer.getShowGutter()),x(J,e.renderer.getShowPrintMargin()),x(K,e.getHighlightSelectedWord()),x(Q,e.renderer.getHScrollBarAlwaysVisible()),x(Y,e.getAnimatedScroll()),x(Z,t.getUseSoftTabs()),x(et,e.getBehavioursEnabled())}function it(){var e=i.split.$editors[0].session,t=i.split.$editors[1].session;e.on("changeScrollTop",function(e){t.setScrollTop(e)}),t.on("changeScrollTop",function(t){e.setScrollTop(t)}),e.on("changeScrollLeft",function(e){t.setScrollLeft(e)}),t.on("changeScrollLeft",function(t){e.setScrollLeft(t)})}e("ace/lib/fixoldbrowsers"),e("ace/multi_select"),e("ace/ext/spellcheck"),e("./inline_editor"),e("./dev_util"),e("./file_drop");var r=e("ace/config");r.init();var i={},s=e("ace/lib/dom"),o=e("ace/lib/net"),u=e("ace/lib/lang"),a=e("ace/lib/useragent"),f=e("ace/lib/event"),l=e("ace/theme/textmate"),c=e("ace/edit_session").EditSession,h=e("ace/undomanager").UndoManager,p=e("ace/keyboard/hash_handler").HashHandler,d=e("ace/virtual_renderer").VirtualRenderer,v=e("ace/editor").Editor,m=e("ace/ext/whitespace"),g=e("./doclist"),y=e("ace/ext/modelist"),b=e("ace/ext/themelist"),w=e("./layout"),E=e("./token_tooltip").TokenTooltip,S=e("./util"),x=S.saveOption,T=S.fillDropdown,N=S.bindCheckbox,C=S.bindDropdown,k=e("ace/ext/elastic_tabstops_lite").ElasticTabstopsLite,L=e("ace/incremental_search").IncrementalSearch,A=e("ace/worker/worker_client");location.href.indexOf("noworker")!==-1&&(A.WorkerClient=A.UIWorkerClient);var O=document.getElementById("editor-container"),M=e("ace/split").Split,_=new M(O,l,1);i.editor=_.getEditor(0),_.on("focus",function(e){i.editor=e,nt()}),i.split=_,window.env=i;var D=s.createElement("div");O.parentNode.appendChild(D),D.style.cssText="position:fixed; bottom:1px; right:0;border:1px solid #baf; z-index:100";var P=new w.singleLineEditor(D);P.editor=i.editor,i.editor.cmdLine=P,i.editor.showCommandLine=function(e){this.cmdLine.focus(),typeof e=="string"&&this.cmdLine.setValue(e,1)},i.editor.commands.addCommands([{name:"gotoline",bindKey:{win:"Ctrl-L",mac:"Command-L"},exec:function(e,t){if(typeof t=="object"){var n=this.name+" "+e.getCursorPosition().row;e.cmdLine.setValue(n,1),e.cmdLine.focus();return}t=parseInt(t,10),isNaN(t)||e.gotoLine(t)},readOnly:!0},{name:"snippet",bindKey:{win:"Alt-C",mac:"Command-Alt-C"},exec:function(e,t){if(typeof t=="object"){e.cmdLine.setValue("snippet ",1),e.cmdLine.focus();return}var n=ut.getSnippetByName(t,e);n&&ut.insertSnippet(e,n.content)},readOnly:!0},{name:"focusCommandLine",bindKey:"shift-esc|ctrl-`",exec:function(e,t){e.cmdLine.focus()},readOnly:!0},{name:"nextFile",bindKey:"Ctrl-tab",exec:function(e){g.cycleOpen(e,1)},readOnly:!0},{name:"previousFile",bindKey:"Ctrl-shift-tab",exec:function(e){g.cycleOpen(e,-1)},readOnly:!0},{name:"execute",bindKey:"ctrl+enter",exec:function(e){try{var t=window.eval(e.getCopyText()||e.getValue())}catch(n){t=n}e.cmdLine.setValue(t+"")},readOnly:!0},{name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-Alt-h",mac:"Command-Alt-h"},exec:function(e){r.loadModule("ace/ext/keybinding_menu",function(t){t.init(e),e.showKeyboardShortcuts()})}},{name:"increaseFontSize",bindKey:"Ctrl-+",exec:function(e){var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(t+1)}},{name:"decreaseFontSize",bindKey:"Ctrl+-",exec:function(e){var t=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(t-1||1))}},{name:"resetFontSize",bindKey:"Ctrl+0",exec:function(e){e.setFontSize(12)}}]),i.editor.commands.addCommands(m.commands),P.commands.bindKeys({"Shift-Return|Ctrl-Return|Alt-Return":function(e){e.insert("\n")},"Esc|Shift-Esc":function(e){e.editor.focus()},Return:function(e){var t=e.getValue().split(/\s+/),n=e.editor;n.commands.exec(t[0],n,t[1]),n.focus()}}),P.commands.removeCommands(["find","gotoline","findall","replace","replaceall"]);var H=i.editor.commands;H.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){var t=i.editor.session,n=t.name.match(/[^\/]+$/);localStorage.setItem("saved_file:"+n,t.getValue()),i.editor.cmdLine.setValue("saved "+n)}}),H.addCommand({name:"load",bindKey:{win:"Ctrl-O",mac:"Command-O"},exec:function(e){var t=i.editor.session,n=t.name.match(/[^\/]+$/),r=localStorage.getItem("saved_file:"+n);typeof r=="string"?(t.setValue(r),i.editor.cmdLine.setValue("loaded "+n)):i.editor.cmdLine.setValue("no previuos value saved for "+n)}});var B={ace:null,vim:e("ace/keyboard/vim").handler,emacs:"ace/keyboard/emacs",custom:new p({gotoright:"Tab",indent:"]",outdent:"[",gotolinestart:"^",gotolineend:"$"})},j=20;window.onresize=F,F();var I=document.getElementById("doc"),q=document.getElementById("mode"),R=document.getElementById("soft_wrap"),U=document.getElementById("theme"),z=document.getElementById("folding"),W=document.getElementById("select_style"),X=document.getElementById("highlight_active"),V=document.getElementById("show_hidden"),$=document.getElementById("show_gutter"),J=document.getElementById("show_print_margin"),K=document.getElementById("highlight_selected_word"),Q=document.getElementById("show_hscroll"),G=document.getElementById("show_vscroll"),Y=document.getElementById("animate_scroll"),Z=document.getElementById("soft_tab"),et=document.getElementById("enable_behaviours");T(I,g.all),T(q,y.modes);var tt=y.modesByName;C("mode",function(e){i.editor.session.setMode(tt[e].mode||tt.text.mode),i.editor.session.modeName=e}),g.history=g.docs.map(function(e){return e.name}),g.history.index=0,g.cycleOpen=function(e,t){var n=this.history;n.index+=t,n.index>=n.length?n.index=0:n.index<=0&&(n.index=n.length-1);var r=n[n.index];I.value=r,I.onchange()},g.addToHistory=function(e){var t=this.history,n=t.indexOf(e);n!=t.index&&(n!=-1&&t.splice(n,1),t.index=t.push(e))},C("doc",function(e){g.loadDoc(e,function(e){if(!e)return;g.addToHistory(e.name),e=i.split.setSession(e),m.detectIndentation(e),nt(),i.editor.focus()})}),b.themes.forEach(function(e){e.value=e.theme}),T(U,{Bright:b.themes.filter(function(e){return!e.isDark}),Dark:b.themes.filter(function(e){return e.isDark})}),f.addListener(U,"mouseover",function(e){U.desiredValue=e.target.value,U.$timer||(U.$timer=setTimeout(U.updateTheme))}),f.addListener(U,"mouseout",function(e){U.desiredValue=null,U.$timer||(U.$timer=setTimeout(U.updateTheme,20))}),U.updateTheme=function(){i.split.setTheme(U.desiredValue||U.selectedValue),U.$timer=null},C("theme",function(e){if(!e)return;i.editor.setTheme(e),U.selectedValue=e}),C("keybinding",function(e){i.editor.setKeyboardHandler(B[e])}),C("fontsize",function(e){i.split.setFontSize(e)}),C("folding",function(e){i.editor.session.setFoldStyle(e),i.editor.setShowFoldWidgets(e!=="manual")}),C("soft_wrap",function(e){var t=i.editor.session,n=i.editor.renderer;switch(e){case"off":t.setUseWrapMode(!1),n.setPrintMarginColumn(80);break;case"free":t.setUseWrapMode(!0),t.setWrapLimitRange(null,null),n.setPrintMarginColumn(80);break;default:t.setUseWrapMode(!0);var r=parseInt(e,10);t.setWrapLimitRange(r,r),n.setPrintMarginColumn(r)}}),N("select_style",function(e){i.editor.setSelectionStyle(e?"line":"text")}),N("highlight_active",function(e){i.editor.setHighlightActiveLine(e)}),N("show_hidden",function(e){i.editor.setShowInvisibles(e)}),N("display_indent_guides",function(e){i.editor.setDisplayIndentGuides(e)}),N("show_gutter",function(e){i.editor.renderer.setShowGutter(e)}),N("show_print_margin",function(e){i.editor.renderer.setShowPrintMargin(e)}),N("highlight_selected_word",function(e){i.editor.setHighlightSelectedWord(e)}),N("show_hscroll",function(e){i.editor.setOption("hScrollBarAlwaysVisible",e)}),N("show_vscroll",function(e){i.editor.setOption("vScrollBarAlwaysVisible",e)}),N("animate_scroll",function(e){i.editor.setAnimatedScroll(e)}),N("soft_tab",function(e){i.editor.session.setUseSoftTabs(e)}),N("enable_behaviours",function(e){i.editor.setBehavioursEnabled(e)}),N("fade_fold_widgets",function(e){i.editor.setFadeFoldWidgets(e)}),N("read_only",function(e){i.editor.setReadOnly(e)}),N("scrollPastEnd",function(e){i.editor.setOption("scrollPastEnd",e)}),C("split",function(e){var t=i.split;if(e=="none")t.setSplits(1);else{var n=t.getSplits()==1;t.setOrientation(e=="below"?t.BELOW:t.BESIDE),t.setSplits(2);if(n){var r=t.getEditor(0).session,s=t.setSession(r,1);s.name=r.name}}}),N("elastic_tabstops",function(e){i.editor.setOption("useElasticTabstops",e)});var rt=N("isearch",function(e){i.editor.setOption("useIncrementalSearch",e)});i.editor.addEventListener("incrementalSearchSettingChanged",function(e){rt.checked=e.isEnabled}),N("highlight_token",function(e){var t=i.editor;t.tokenTooltip&&!e?(t.tokenTooltip.destroy(),delete t.tokenTooltip):e&&(t.tokenTooltip=new E(t))});var st=e("ace/ext/statusbar").StatusBar;new st(i.editor,P.container);var ot=e("ace/ext/emmet");o.loadScript("http://nightwing.github.io/emmet-core/emmet.js",function(){ot.setCore(window.emmet),i.editor.setOption("enableEmmet",!0)});var ut=e("ace/snippets").snippetManager;i.editSnippets=function(){var e=i.split;if(e.getSplits()==2){e.setSplits(1);return}e.setSplits(1),e.setSplits(2),e.setOrientation(e.BESIDE);var t=e.$editors[1],n=e.$editors[0].session.$mode.$id||"",r=ut.files[n];if(!g["snippets/"+n]){var s=r.snippetText,o=g.initDoc(s,"",{});o.setMode("ace/mode/snippets"),g["snippets/"+n]=o}t.on("blur",function(){r.snippetText=t.getValue(),ut.unregister(r.snippets),r.snippets=ut.parseSnippetFile(r.snippetText,r.scope),ut.register(r.snippets)}),e.$editors[0].once("changeMode",function(){e.setSplits(1)}),t.setSession(g["snippets/"+n],1),t.focus()},e("ace/ext/language_tools"),i.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0})});