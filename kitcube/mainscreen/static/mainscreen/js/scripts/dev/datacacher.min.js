DataStream=function(e,t,n){this._byteOffset=t||0;if(e instanceof ArrayBuffer){this.buffer=e}else if(typeof e=="object"){this.dataView=e;if(t){this._byteOffset+=t}}else{this.buffer=new ArrayBuffer(e||0)}this.position=0;this.endianness=n==null?DataStream.LITTLE_ENDIAN:n};DataStream.prototype={};DataStream.BIG_ENDIAN=false;DataStream.LITTLE_ENDIAN=true;DataStream.prototype._dynamicSize=true;Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(e){if(!e){this._trimAlloc()}this._dynamicSize=e}});DataStream.prototype._byteLength=0;Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}});Object.defineProperty(DataStream.prototype,"buffer",{get:function(){this._trimAlloc();return this._buffer},set:function(e){this._buffer=e;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(e){this._byteOffset=e;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(e){this._byteOffset=e.byteOffset;this._buffer=e.buffer;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._byteOffset+e.byteLength}});DataStream.prototype._realloc=function(e){if(!this._dynamicSize){return}var t=this._byteOffset+this.position+e;var n=this._buffer.byteLength;if(t<=n){if(t>this._byteLength){this._byteLength=t}return}if(n<1){n=1}while(t>n){n*=2}var r=new ArrayBuffer(n);var i=new Uint8Array(this._buffer);var s=new Uint8Array(r,0,i.length);s.set(i);this.buffer=r;this._byteLength=t};DataStream.prototype._trimAlloc=function(){if(this._byteLength==this._buffer.byteLength){return}var e=new ArrayBuffer(this._byteLength);var t=new Uint8Array(e);var n=new Uint8Array(this._buffer,0,t.length);t.set(n);this.buffer=e};DataStream.prototype.seek=function(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t};DataStream.prototype.isEof=function(){return this.position>=this._byteLength};DataStream.prototype.mapInt32Array=function(e,t){this._realloc(e*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*4;return n};DataStream.prototype.mapInt16Array=function(e,t){this._realloc(e*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*2;return n};DataStream.prototype.mapInt8Array=function(e){this._realloc(e*1);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);this.position+=e*1;return t};DataStream.prototype.mapUint32Array=function(e,t){this._realloc(e*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*4;return n};DataStream.prototype.mapUint16Array=function(e,t){this._realloc(e*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*2;return n};DataStream.prototype.mapUint8Array=function(e){this._realloc(e*1);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);this.position+=e*1;return t};DataStream.prototype.mapFloat64Array=function(e,t){this._realloc(e*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*8;return n};DataStream.prototype.mapFloat32Array=function(e,t){this._realloc(e*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,e);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=e*4;return n};DataStream.prototype.readInt32Array=function(e,t){e=e==null?this.byteLength-this.position/4:e;var n=new Int32Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.readInt16Array=function(e,t){e=e==null?this.byteLength-this.position/2:e;var n=new Int16Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.readInt8Array=function(e){e=e==null?this.byteLength-this.position:e;var t=new Int8Array(e);DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT);this.position+=t.byteLength;return t};DataStream.prototype.readUint32Array=function(e,t){e=e==null?this.byteLength-this.position/4:e;var n=new Uint32Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.readUint16Array=function(e,t){e=e==null?this.byteLength-this.position/2:e;var n=new Uint16Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.readUint8Array=function(e){e=e==null?this.byteLength-this.position:e;var t=new Uint8Array(e);DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT);this.position+=t.byteLength;return t};DataStream.prototype.readFloat64Array=function(e,t){e=e==null?this.byteLength-this.position/8:e;var n=new Float64Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.readFloat32Array=function(e,t){e=e==null?this.byteLength-this.position/4:e;var n=new Float32Array(e);DataStream.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,e*n.BYTES_PER_ELEMENT);DataStream.arrayToNative(n,t==null?this.endianness:t);this.position+=n.byteLength;return n};DataStream.prototype.writeInt32Array=function(e,t){this._realloc(e.length*4);if(e instanceof Int32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapInt32Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeInt32(e[n],t)}}};DataStream.prototype.writeInt16Array=function(e,t){this._realloc(e.length*2);if(e instanceof Int16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapInt16Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeInt16(e[n],t)}}};DataStream.prototype.writeInt8Array=function(e){this._realloc(e.length*1);if(e instanceof Int8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapInt8Array(e.length)}else{for(var t=0;t<e.length;t++){this.writeInt8(e[t])}}};DataStream.prototype.writeUint32Array=function(e,t){this._realloc(e.length*4);if(e instanceof Uint32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapUint32Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeUint32(e[n],t)}}};DataStream.prototype.writeUint16Array=function(e,t){this._realloc(e.length*2);if(e instanceof Uint16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapUint16Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeUint16(e[n],t)}}};DataStream.prototype.writeUint8Array=function(e){this._realloc(e.length*1);if(e instanceof Uint8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapUint8Array(e.length)}else{for(var t=0;t<e.length;t++){this.writeUint8(e[t])}}};DataStream.prototype.writeFloat64Array=function(e,t){this._realloc(e.length*8);if(e instanceof Float64Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapFloat64Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeFloat64(e[n],t)}}};DataStream.prototype.writeFloat32Array=function(e,t){this._realloc(e.length*4);if(e instanceof Float32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT==0){DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength);this.mapFloat32Array(e.length,t)}else{for(var n=0;n<e.length;n++){this.writeFloat32(e[n],t)}}};DataStream.prototype.readInt32=function(e){var t=this._dataView.getInt32(this.position,e==null?this.endianness:e);this.position+=4;return t};DataStream.prototype.readInt16=function(e){var t=this._dataView.getInt16(this.position,e==null?this.endianness:e);this.position+=2;return t};DataStream.prototype.readInt8=function(){var e=this._dataView.getInt8(this.position);this.position+=1;return e};DataStream.prototype.readUint32=function(e){var t=this._dataView.getUint32(this.position,e==null?this.endianness:e);this.position+=4;return t};DataStream.prototype.readUint16=function(e){var t=this._dataView.getUint16(this.position,e==null?this.endianness:e);this.position+=2;return t};DataStream.prototype.readUint8=function(){var e=this._dataView.getUint8(this.position);this.position+=1;return e};DataStream.prototype.readFloat32=function(e){var t=this._dataView.getFloat32(this.position,e==null?this.endianness:e);this.position+=4;return t};DataStream.prototype.readFloat64=function(e){var t=this._dataView.getFloat64(this.position,e==null?this.endianness:e);this.position+=8;return t};DataStream.prototype.writeInt32=function(e,t){this._realloc(4);this._dataView.setInt32(this.position,e,t==null?this.endianness:t);this.position+=4};DataStream.prototype.writeInt16=function(e,t){this._realloc(2);this._dataView.setInt16(this.position,e,t==null?this.endianness:t);this.position+=2};DataStream.prototype.writeInt8=function(e){this._realloc(1);this._dataView.setInt8(this.position,e);this.position+=1};DataStream.prototype.writeUint32=function(e,t){this._realloc(4);this._dataView.setUint32(this.position,e,t==null?this.endianness:t);this.position+=4};DataStream.prototype.writeUint16=function(e,t){this._realloc(2);this._dataView.setUint16(this.position,e,t==null?this.endianness:t);this.position+=2};DataStream.prototype.writeUint8=function(e){this._realloc(1);this._dataView.setUint8(this.position,e);this.position+=1};DataStream.prototype.writeFloat32=function(e,t){this._realloc(4);this._dataView.setFloat32(this.position,e,t==null?this.endianness:t);this.position+=4};DataStream.prototype.writeFloat64=function(e,t){this._realloc(8);this._dataView.setFloat64(this.position,e,t==null?this.endianness:t);this.position+=8};DataStream.endianness=(new Int8Array((new Int16Array([1])).buffer))[0]>0;DataStream.memcpy=function(e,t,n,r,i){var s=new Uint8Array(e,t,i);var o=new Uint8Array(n,r,i);s.set(o)};DataStream.arrayToNative=function(e,t){if(t==this.endianness){return e}else{return this.flipArrayEndianness(e)}};DataStream.nativeToEndian=function(e,t){if(this.endianness==t){return e}else{return this.flipArrayEndianness(e)}};DataStream.flipArrayEndianness=function(e){var t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(var n=0;n<e.byteLength;n+=e.BYTES_PER_ELEMENT){for(var r=n+e.BYTES_PER_ELEMENT-1,i=n;r>i;r--,i++){var s=t[i];t[i]=t[r];t[r]=s}}return e};DataStream.prototype.failurePosition=0;DataStream.prototype.readStruct=function(e){var t={},n,r,i;var s=this.position;for(var o=0;o<e.length;o+=2){n=e[o+1];r=this.readType(n,t);if(r==null){if(this.failurePosition==0){this.failurePosition=this.position}this.position=s;return null}t[e[o]]=r}return t};DataStream.prototype.readUCS2String=function(e,t){return String.fromCharCode.apply(null,this.readUint16Array(e,t))};DataStream.prototype.writeUCS2String=function(e,t,n){if(n==null){n=e.length}for(var r=0;r<e.length&&r<n;r++){this.writeUint16(e.charCodeAt(r),t)}for(;r<n;r++){this.writeUint16(0)}};DataStream.prototype.readString=function(e,t){if(t==null||t=="ASCII"){return String.fromCharCode.apply(null,this.mapUint8Array(e==null?this.byteLength-this.position:e))}else{return(new TextDecoder(t)).decode(this.mapUint8Array(e))}};DataStream.prototype.writeString=function(e,t,n){if(t==null||t=="ASCII"){if(n!=null){var r=0;var i=Math.min(e.length,n);for(r=0;r<i;r++){this.writeUint8(e.charCodeAt(r))}for(;r<n;r++){this.writeUint8(0)}}else{for(var r=0;r<e.length;r++){this.writeUint8(e.charCodeAt(r))}}}else{this.writeUint8Array((new TextEncoder(t)).encode(e.substring(0,n)))}};DataStream.prototype.readCString=function(e){var t=this.byteLength-this.position;var n=new Uint8Array(this._buffer,this._byteOffset+this.position);var r=t;if(e!=null){r=Math.min(e,t)}for(var i=0;i<r&&n[i]!=0;i++);var s=String.fromCharCode.apply(null,this.mapUint8Array(i));if(e!=null){this.position+=r-i}else if(i!=t){this.position+=1}return s};DataStream.prototype.writeCString=function(e,t){if(t!=null){var n=0;var r=Math.min(e.length,t);for(n=0;n<r;n++){this.writeUint8(e.charCodeAt(n))}for(;n<t;n++){this.writeUint8(0)}}else{for(var n=0;n<e.length;n++){this.writeUint8(e.charCodeAt(n))}this.writeUint8(0)}};DataStream.prototype.readType=function(e,t){if(typeof e=="function"){return e(this,t)}else if(typeof e=="object"&&!(e instanceof Array)){return e.get(this,t)}else if(e instanceof Array&&e.length!=3){return this.readStruct(e,t)}var n=null;var r=null;var i="ASCII";var s=this.position;if(typeof e=="string"&&/:/.test(e)){var o=e.split(":");e=o[0];r=parseInt(o[1])}if(typeof e=="string"&&/,/.test(e)){var o=e.split(",");e=o[0];i=parseInt(o[1])}switch(e){case"uint8":n=this.readUint8();break;case"int8":n=this.readInt8();break;case"uint16":n=this.readUint16(this.endianness);break;case"int16":n=this.readInt16(this.endianness);break;case"uint32":n=this.readUint32(this.endianness);break;case"int32":n=this.readInt32(this.endianness);break;case"float32":n=this.readFloat32(this.endianness);break;case"float64":n=this.readFloat64(this.endianness);break;case"uint16be":n=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":n=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":n=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":n=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":n=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":n=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":n=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":n=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":n=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":n=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":n=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":n=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":n=this.readCString(r);break;case"string":n=this.readString(r,i);break;case"u16string":n=this.readUCS2String(r,this.endianness);break;case"u16stringle":n=this.readUCS2String(r,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":n=this.readUCS2String(r,DataStream.BIG_ENDIAN);break;default:if(e.length==3){var u=e[1];var a=e[2];var f=0;if(typeof a=="function"){f=a(t,this,e)}else if(typeof a=="string"&&t[a]!=null){f=parseInt(t[a])}else{f=parseInt(a)}if(typeof u=="string"){var l=u.replace(/(le|be)$/,"");var c=null;if(/le$/.test(u)){c=DataStream.LITTLE_ENDIAN}else if(/be$/.test(u)){c=DataStream.BIG_ENDIAN}if(a=="*"){f=null}switch(l){case"uint8":n=this.readUint8Array(f);break;case"uint16":n=this.readUint16Array(f,c);break;case"uint32":n=this.readUint32Array(f,c);break;case"int8":n=this.readInt8Array(f);break;case"int16":n=this.readInt16Array(f,c);break;case"int32":n=this.readInt32Array(f,c);break;case"float32":n=this.readFloat32Array(f,c);break;case"float64":n=this.readFloat64Array(f,c);break;case"cstring":case"utf16string":case"string":if(f==null){n=[];while(!this.isEof()){var h=this.readType(u,t);if(h==null)break;n.push(h)}}else{n=new Array(f);for(var p=0;p<f;p++){n[p]=this.readType(u,t)}}break}}else{if(a=="*"){n=[];this.buffer;while(true){var d=this.position;try{var v=this.readType(u,t);if(v==null){this.position=d;break}n.push(v)}catch(m){this.position=d;break}}}else{n=new Array(f);for(var p=0;p<f;p++){var h=this.readType(u,t);if(h==null)return null;n[p]=h}}}break}}if(r!=null){this.position=s+r}return n};DataStream.prototype.writeStruct=function(e,t){for(var n=0;n<e.length;n+=2){var r=e[n+1];this.writeType(r,t[e[n]],t)}};DataStream.prototype.writeType=function(e,t,n){if(typeof e=="function"){return e(this,t)}else if(typeof e=="object"&&!(e instanceof Array)){return e.set(this,t,n)}var r=null;var i="ASCII";var s=this.position;if(typeof e=="string"&&/:/.test(e)){var o=e.split(":");e=o[0];r=parseInt(o[1])}if(typeof e=="string"&&/,/.test(e)){var o=e.split(",");e=o[0];i=parseInt(o[1])}switch(e){case"uint8":this.writeUint8(t);break;case"int8":this.writeInt8(t);break;case"uint16":this.writeUint16(t,this.endianness);break;case"int16":this.writeInt16(t,this.endianness);break;case"uint32":this.writeUint32(t,this.endianness);break;case"int32":this.writeInt32(t,this.endianness);break;case"float32":this.writeFloat32(t,this.endianness);break;case"float64":this.writeFloat64(t,this.endianness);break;case"uint16be":this.writeUint16(t,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(t,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(t,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(t,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(t,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(t,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(t,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(t,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(t,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(t,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(t,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(t,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(t,r);break;case"string":this.writeString(t,i,r);break;case"u16string":this.writeUCS2String(t,this.endianness,r);break;case"u16stringle":this.writeUCS2String(t,DataStream.LITTLE_ENDIAN,r);break;case"u16stringbe":this.writeUCS2String(t,DataStream.BIG_ENDIAN,r);break;default:if(e.length==3){var u=e[1];for(var a=0;a<t.length;a++){this.writeType(u,t[a])}break}else{this.writeStruct(e,t);break}}if(r!=null){this.position=s;this._realloc(r);this.position=s+r}};var dateTimeFormat=function(){var e={};e.monthFormats={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};e.splitTimeFromAny=function(e){var t=e.substr(19);var n=e.substr(7,2);var r=e.substr(3,3);var i=e.substr(0,2);var s=e.substr(10,2);var o=e.substr(13,2);var u=e.substr(16,2);if(n>60){n="19"+n}else{n="20"+n}var a=new Date(n,this.monthFormats[r],i,s,o,u);var f=a.toISOString().substr(13).substring(0,7);a.setMinutes(a.getMinutes()-a.getTimezoneOffset());var l=a.toISOString().substring(0,13);l=l+f+t;return l};e.formatTime=function(e){var t=e.split("-")[0];var n=e.split("-")[1];if(t.indexOf(".")-1){t=t.split(".")[0]}if(n.indexOf(".")-1){n=n.split(".")[0]}return{begTime:t,endTime:n}};e.splitTimeFromUnix=function(e){var t=e.split(".")[1];if(t==undefined){t="000000"}var n=new Date(e*1e3);var r=n.toISOString().substr(13).substring(0,7);n.setMinutes(n.getMinutes()-n.getTimezoneOffset());var i=n.toISOString().substring(0,13);i=i+r+t;return i};e.checkWindowFormat=function(e){var t=e.split("-")[0];var n=e.split("-")[1];if(t!=undefined&&n!=undefined){var r=t.split(".")[1];var i=n.split(".")[1];if(r!==undefined&&i!==undefined){n=n.split(".")[0];t=t.split(".")[0];r=parseInt(r);i=parseInt(i);t=parseInt(t);n=parseInt(n);if(r!=NaN&&i!=NaN&&t!=NaN&&n!=NaN){return true}else{return false}}else{if(typeof parseInt(t)==="number"&&typeof parseInt(n)==="number"){return true}else{return false}}}else{return false}};return e};var dataHandler=function(e){var t={};t.dateHelper=new dateTimeFormat;t.db_server="";t.db_name="";t.db_group="";t.db_mask="";t.window="";t.aggregation="";t.communicationType=e;t.lineSeparator="\r\n";t.separator=",";t.beginTime="";t.endTime="";t.pointCount="";t.level="";t.labels="";t.isOnePortion=true;t.backCachers=[];t.onEndOfWork="";t.dataLevel=[];t.startBackgroundCaching=function(e,t,n){if(e.window>=0){var r=this.formDbMask();var i=this.formLabels();var s=this.formDataLevels();var o=this.aggregation;if(e.window==0){o="v"}var u=new Worker("/static/mainscreen/js/scripts/dev/datacaching/backgrDataCacher.js");this.backCachers.push(u);u.postMessage(this.db_server+"<>"+this.db_name+"<>"+this.db_group+"<>"+this.window+"<>"+e.window+"<>"+t+"<>"+n+"<>"+r+"<>"+i+"<>"+s+"<>"+o+"<>"+this.communicationType)}};t.formDbMask=function(){var e=this.db_mask[0];for(var t=1;t<this.db_mask.length;t++){e=e+","+this.db_mask[t]}return e};t.formLabels=function(){var e=this.labels[0];for(var t=1;t<this.labels.length;t++){e=e+","+this.labels[t]}return e};t.formDataLevels=function(){var e=this.dataLevel[0].window;for(var t=1;t<this.dataLevel.length;t++){e=e+","+this.dataLevel[t].window}return e};t.setNewRequest=function(e,t,n,r,i,s){this.db_server=e;this.db_name=t;this.db_group=n;this.db_mask=r;this.window=i;this.beginTime=this.window.split("-")[0];this.endTime=this.window.split("-")[1];this.pointCount=s;this.level=this.getDataLevel(this.pointCount,this.window)};t.setRequest=function(e,t){this.window=e;this.beginTime=this.window.split("-")[0];this.endTime=this.window.split("-")[1];this.pointCount=t;this.level=this.getDataLevel(this.pointCount,this.window)};t.isPriviousRequest=function(e,t,n,r,i){if(this.db_server==e&&this.db_name==t&&this.db_group==n&&this.aggregation==r){var s=0;for(var o=0;o<this.db_mask.length;o++){if(this.db_mask[o]==i[o]){s++}}if(s==this.db_mask.length){return true}else{return false}}else{return false}};t.setDataLevels=function(e){this.dataLevel=[];for(var t=0;t<e.length;t++){var n={};n.window=e[t];this.dataLevel.push(n)}};t.concatRowData=function(e,t,n){var r=Object.keys(e.rows.item(0));for(var i=0;i<r.length-1;i++){t.push([])}for(var s=0;s<e.rows.length;s++){for(var o=0;o<r.length;o++){if(r[o]=="DateTime"){n.push(e.rows.item(s).DateTime)}else{var u=e.rows.item(s)[r[o]];t[o-1].push(u)}}}};t.getDataLevel=function(e,t){var n=t.split("-")[1]-t.split("-")[0];var r=n/e;var i;for(var s=0;s<this.dataLevel.length;s++){if(this.dataLevel[s].window>r){continue}i=this.dataLevel[s];break}return i};t.getDataLevelForBackgr=function(e){for(var t=0;t<this.dataLevel.length;t++){if(this.dataLevel[t]==e){if(t==this.dataLevel.length-1){return e}else{return this.dataLevel[t+1]}}}};t.getDbServer=function(){return this.db_server};t.getDbName=function(){return this.db_name};t.getDbGroup=function(){return this.db_group};t.getDbMask=function(){return this.db_mask};t.getBeginTime=function(){return this.beginTime};t.setBeginTime=function(e){this.beginTime=e};t.getEndTime=function(){return this.endTime};t.setEndTime=function(e){this.endTime=e};t.getWindow=function(){return this.window};t.setWindow=function(e){this.window=e};t.getLabels=function(){return this.labels};t.getDataLevelForUp=function(e){for(var t=0;t<this.dataLevel.length;t++){if(this.dataLevel[t]==e){if(t==0){return e}else{return this.dataLevel[t-1]}}}};t.setLabels=function(e){this.labels=e};t.setOnEndOfWorkCallback=function(e){this.onEndOfWork=e};t.setReadingMode=function(e){this.isOnePortion=e};t.setAggregation=function(e){this.aggregation=e};t.getAggregation=function(){return this.aggregation};t.deleteWorkers=function(){if(this.backCachers.length!==0){for(var e=0;e<this.backCachers.length;e++){this.backCachers[e].terminate()}this.backCachers=[]}};t.formatBeginUnixTime=function(){var e=this.beginTime/this.level.window;e=parseInt(e);e=e*this.level.window;return e};t.formatEndUnixTime=function(){var e=this.endTime/this.level.window;e=parseInt(e);e=e*this.level.window;return e};t.onMessageRecieved=function(e){if(this.isOnePortion){var t=new DataStream(e.data);t.endianness=t.BIG_ENDIAN;var n=[];var r=[];for(var i=0;i<this.db_mask.length;i++){r.push([])}try{while(!t.isEof()){var s=t.readString(29);n.push(this.formatToUnix(s));for(var i=0;i<this.db_mask.length;i++){r[i].push(t.readFloat64(true))}}}catch(o){console.log(o);console.log(String.fromCharCode.apply(null,new Uint16Array(e.data)))}}this.onEndOfWork({data:r,dateTime:n,label:this.labels})};t.onMessageRecievedCsv=function(e){var t=this;var n=e.split(t.lineSeparator);var r=n[0].split(t.separator);var i=[];var s=[];for(var o=0;o<r.length;o++){s.push([])}for(var o=1;o<n.length-1;o++){var u=n[o].split(t.separator);var a=t.dateHelper.splitTimeFromAny(u[0]);a=(new Date(a)).getTime()/1e3;i.push(a);for(var f=0;f<u.length-1;f++){s[f].push(parseFloat(u[f+1]))}}this.onEndOfWork({data:s,dateTime:i,label:this.labels})};t.onMessageRecievedBinary=function(e){var t=new DataStream(e);t.readString(1);t.endianness=t.BIG_ENDIAN;var n=[];var r=[];for(var i=0;i<this.db_mask.length;i++){r.push([])}try{while(!t.isEof()){var s=t.readString(26);n.push(this.formatToUnix(s));for(var i=0;i<this.db_mask.length;i++){r[i].push(t.readFloat64(true))}}}catch(o){console.log(o);console.log(String.fromCharCode.apply(null,new Uint16Array(e.data)))}this.onEndOfWork({data:r,dateTime:n,label:this.labels})};t.formatToUnix=function(e){var t=e.split(".")[0];var n=e.split(".")[1];var r=(new Date(t.replace(" ","T"))).getTime()/1e3+"."+n;return r};return t};var dataCacher=function(e,t,n,r,i){var s={};s.dataHandl=new dataHandler(e);s.dateHelper=new dateTimeFormat;s.communicationType=e;s.isCache=t;s.isCacheDown=n;s.isCacheUp=r;s.isCacheCurrent=i;s.HostURL="http://katrin.kit.edu/adei";s.db="";s.clientsCallback="";s.level="";s.columns="";s.tableName="";s.labels=[];s.db_items=[];s.aggregation="";s.isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(s.isFirefox){s.isCache=false;s.isCacheDown=false;s.isCacheUp=false;s.isCacheCurrent=false}s.getData=function(e,t,n,r,i,s,o,u){var a=this;var f=r.split(",");f.sort();a.dataHandl.deleteWorkers();a.clientsCallback=u;a.aggregation=o;if(a.dataHandl.isPriviousRequest()){if(r!="all"){a.db_items=f}else{a.db_items=a.dataHandl.getDbMask()}a.dataHandl.setRequest(i,s);a.level=a.dataHandl.level;a.columns=a.formTableColumns();a.tableName=a.formTableName(a.level.window);a.onReadyFormingRequest()}else{if(!a.isFirefox){a.db.transaction(function(u){var l='SELECT * FROM DataSource WHERE ((db_server="'+e+'") AND (db_name="'+t+'")) AND ((db_group="'+n+'") AND (aggregation="'+o+'")) AND (db_items="'+f+'")';u.executeSql(l,[],function(u,l){if(l.rows.length==0){if(r!="all"){a.db_items=f;r=a.db_items}else{r=a.formDbMask(e,t,n);a.db_items=r}var c=a.formDataLevels(e,t,n);a.dataHandl.setDataLevels(c.reverse());a.dataHandl.setAggregation(o);a.dataHandl.setNewRequest(e,t,n,r,i,s);a.level=a.dataHandl.level;a.columns=a.formTableColumns();a.dataHandl.setLabels(a.formLabels());a.tableName=a.formTableName(a.level.window);a.onReadyFormingRequest()}else{if(r!="all"){a.db_items=r.split(",");r=l.rows.item(0).db_items.split(",")}else{r=l.rows.item(0).db_items.split(",");a.db_items=r}a.dataHandl.setDataLevels(l.rows.item(0).datalevels.split(","));a.dataHandl.setAggregation(l.rows.item(0).aggregation);a.dataHandl.setNewRequest(e,t,n,r,i,s);a.dataHandl.setLabels(l.rows.item(0).labels.split(","));a.columns=a.formTableColumns();a.level=a.dataHandl.level;a.tableName=a.formTableName(a.level.window);a.onReadyFormingRequest()}},a.onErrorSql.bind(a))})}else{if(r!="all"){a.db_items=f;r=a.db_items}else{r=a.formDbMask(e,t,n);a.db_items=r}var l=a.formDataLevels(e,t,n);a.dataHandl.setDataLevels(l.reverse());a.dataHandl.setAggregation(o);a.dataHandl.setNewRequest(e,t,n,r,i,s);a.level=a.dataHandl.level;a.columns=a.formTableColumns();a.dataHandl.setLabels(a.formLabels());a.tableName=a.formTableName(a.level.window);a.onReadyFormingRequest()}}};s.onReadyFormingRequest=function(){var e=this;if(!e.isFirefox){e.db.transaction(function(t){var n=e.formDataSourceStatement();t.executeSql(n,[],function(t,n){if(n.rows.length==0){e.requestData(e.dataHandl.getWindow())}else{var r=n.rows.item(0).id;var i=e.dateHelper.formatTime(e.dataHandl.getWindow());var s='SELECT * FROM "'+r+'" WHERE  (DateTime) <=  '+parseInt(i.endTime)+" AND (DateTime) >= "+parseInt(i.begTime)+" ORDER BY DateTime";t.executeSql(s,[],e.onReturnResult.bind(e))}},e.onErrorSql.bind(e))},e.onError.bind(e),e.onReadyTransaction)}else{e.requestData(e.dataHandl.getWindow())}};s.requestData=function(e){var t=this;var n=t.dateHelper.formatTime(e);switch(t.communicationType){case"websockets":t.dataHandl.setReadingMode(true);t.webSocket.sendMessage(t.tableName+";"+e+";"+"1"+";"+t.dataHandl.getAggregation()+";"+t.dataHandl.getDbMask().length+";"+t.dataHandl.formDbMask()+";");break;case"httpgetcsv":var r=t.formURLGetCsv(t.dataHandl.getDbServer(),t.dataHandl.getDbName(),t.dataHandl.getDbGroup(),t.dataHandl.formDbMask(),n.begTime+"-"+n.endTime,t.level.window);t.httpGetCsv(r,t.dataHandl.onMessageRecievedCsv.bind(t.dataHandl));break;case"httpgetbinary":t.dataHandl.setReadingMode(true);var r=t.formURLGetBinary(t.dataHandl.getDbServer(),t.dataHandl.getDbName(),t.dataHandl.getDbGroup(),t.dataHandl.formDbMask(),n.begTime+"-"+n.endTime,t.level.window);t.httpGetBinary(r,t.dataHandl.onMessageRecievedBinary.bind(t.dataHandl));break}};s.onReturnResult=function(e,t){var n=this;if(!n.isFirefox){if(t.rows.length!==0){var r=[];var i=[];var s=[];n.dataHandl.concatRowData(t,r,i);s=n.dataHandl.getLabels();if(n.isCache){n.startBackgroundCachers()}n.clientsCallback({data:r,dateTime:i,label:s})}else{n.insertNeedenDataBckgr(n.dataHandl.getWindow())}}else{}};s.startBackgroundCachers=function(){var e=this;if(parseInt(e.level.window)!=e.dataHandl.dataLevel[0]&&e.isCacheUp===true){var t=e.dataHandl.getDataLevelForUp(e.level);var n=e.formTableName(t.window);e.dataHandl.startBackgroundCaching(t,e.columns,n)}if(parseInt(e.level.window)!=0&&e.isCacheDown===true){var r=e.dataHandl.getDataLevelForBackgr(e.level);var i=e.formTableName(r.window);e.dataHandl.startBackgroundCaching(r,e.columns,i)}if(e.isCacheCurrent===true){var s=parseFloat(e.dataHandl.getBeginTime());var o=parseFloat(e.dataHandl.getEndTime());var u=o-s;var a=s-u;var f=o+u;e.dataHandl.setBeginTime(a);e.dataHandl.setEndTime(f);e.dataHandl.setWindow(a+"-"+f);e.dataHandl.startBackgroundCaching(e.level,e.columns,e.tableName)}};s.insertNeedenDataBckgr=function(e){var t=this;t.requestData(e)};s.splitData=function(e){var t=this;e.label=t.dataHandl.getLabels();var n={};n.data=[];n.dateTime=e.dateTime;n.label=e.label.slice(0);for(var r=0;r<t.db_items.length;r++){n.data.push(e.data[r].slice(0))}return n};s.onReadyFormingData=function(e){var t=this;if(e.dateTime.length!=0){if(e.data[0].length<1e4){if(!t.isFirefox){if(t.isCache){t.dataHandl.startBackgroundCaching(t.level,t.columns,t.tableName);t.startBackgroundCachers()}}t.clientsCallback(e)}else{t.clientsCallback(e);console.log("Too much points in request.")}}else{t.clientsCallback(null);throw"There is no data in server responces."}};s.openDataBase=function(e){if(this.db==""){try{this.db=openDatabase(e,"1.0","",300*1024*1024)||window.openDatabase(e,"1.0","",300*1024*1024)}catch(t){}}};s.formDataBase=function(){this.db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS DataSource (id INTEGER PRIMARY KEY AUTOINCREMENT,db_server,db_name,db_group, aggregation, level, db_items, labels, datalevels)",[],function(e,t){})},this.onError.bind(this),this.onReadyTransaction)};s.onReadyTransaction=function(){};s.onError=function(e){alert("Error in caching module: "+e.message+"\n\n\n To solve this problem, try to clear your cache in browser.");this.openDataBase("DB")};s.onErrorSql=function(e,t){alert("Error in caching module: "+t.message+"\n\n\n To solve this problem, try to clear your cache in browser.");this.openDataBase("DB")};s.onReadySql=function(){console.log("Executing SQL completed.")};s.onOpenSocket=function(){console.log("Socket opened.")};s.onErrorSocket=function(e){this.communicationType="httpgetbinary";console.log(e)};s.onCloseSocket=function(){console.log("Socket closed.")};s.formURL=function(e,t,n,r,i){var s=this.HostURL+"/services/getdata.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&db_mask=all"+"&experiment="+r+"&window=0"+"&resample="+i+"&format=csv";return s};s.formURLList=function(e,t,n,r){var i=this.HostURL+"/services/list.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&target="+r;return i};s.formURLLabel=function(e,t,n,r,i){var s=this.HostURL+"/services/list.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&db_mask="+r+"&target="+i;return s};s.formURLInfo=function(e,t,n,r){var i=this.HostURL+"/services/info.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&target="+r;return i};s.formDataLevels=function(e,t,n){var r=this;var i=r.formURLInfo(e,t,n,"cache");var s=r.httpGetXml(i);var o=s.getElementsByTagName("Value");var u=o[0].getAttribute("resolutions").split(",");return u};s.formDbMask=function(e,t,n){var r=this;var i=r.formURLList(e,t,n,"items");var s=r.httpGetXml(i);var o=s.getElementsByTagName("Value");var u=[];for(var a=0;a<o.length;a++){u.push(o[a].getAttribute("value"))}return u};s.formTableName=function(e){var t=this;var n="cache"+e+"__"+t.dataHandl.getDbServer()+"__"+t.dataHandl.getDbName()+"__"+t.dataHandl.getDbGroup();return n};s.formDataSourceStatement=function(){var e=this;var t=e.dataHandl.getAggregation();if(parseInt(e.level.window)===0){t="v"}var n='SELECT * FROM DataSource WHERE ((db_server="'+e.dataHandl.getDbServer()+'") AND \n                                                                    (db_name="'+e.dataHandl.getDbName()+'")) AND \n                                                                    ((db_group="'+e.dataHandl.getDbGroup()+'") AND \n                                                                     (level="'+e.level.window+'")) AND \n                                                                    (aggregation="'+t+'") AND \n                                                                    (db_items="'+e.db_items+'")';return n};s.formTableColumns=function(){var e=this;var t=e.dataHandl.getDbMask();var n="";for(var r=0;r<t.length;r++){n=n+", column"+t[r]}return n};s.formLabels=function(){var e=this;var t=e.formURLLabel(e.dataHandl.getDbServer(),e.dataHandl.getDbName(),e.dataHandl.getDbGroup(),e.dataHandl.getDbMask(),"items");var n=e.httpGetXml(t);var r=n.getElementsByTagName("Value");var i=[];for(var s=0;s<r.length;s++){i.push(r[s].getAttribute("name"))}return i};s.formValues=function(e,t){var n="";for(var r=0;r<e.length;r++){n=n+","+e[r][t]}return n};s.httpGetXml=function(e){var t=null;t=new XMLHttpRequest;t.open("GET",e,false);t.send(null);return t.responseXML};s.httpGetCsv=function(e,t){var n=null;n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState==4&&n.status==200){t(n.responseText)}};n.open("GET",e,true);n.send(null)};s.httpGetBinary=function(e,t){var n=null;n=new XMLHttpRequest;n.onload=function(){t(n.response)};n.open("GET",e,true);n.responseType="arraybuffer";n.send(null)};s.formURLGetCsv=function(e,t,n,r,i,s){var o=this.HostURL+"/services/getdata.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&db_mask="+r+"&experiment="+i+"&window=0"+"&resample="+s+"&format=csv";return o};s.formURLGetBinary=function(e,t,n,r,i,s){var o=this.HostURL+"/services/getdata.php?db_server="+e+"&db_name="+t+"&db_group="+n+"&db_mask="+r+"&experiment="+i+"&window=0"+"&resample="+s+"&format=binary";return o};s.openDataBase("DB");s.formDataBase();if(s.communicationType==="websockets"){s.webSocket=new webSockets("ws://ipecluster5.ipe.kit.edu:12345");s.webSocket.openSocket();s.webSocket.setOnOpenCallback(s.onOpenSocket);s.webSocket.setOnCloseCallback(s.onCloseSocket);s.webSocket.setOnErrorCallback(s.onErrorSocket.bind(s));s.webSocket.setOnMessageCallback(s.dataHandl.onMessageRecieved.bind(s.dataHandl))}s.dataHandl.setOnEndOfWorkCallback(s.onReadyFormingData.bind(s));return s};webSockets=function(e){var t={};t.socket="";t.host=e;t.openSocket=function(){try{this.socket=new WebSocket(this.host);this.socket.binaryType="arraybuffer"}catch(e){console.log(e)}};t.setOnOpenCallback=function(e){this.socket.onopen=e};t.setOnMessageCallback=function(e){this.socket.onmessage=e};t.setOnCloseCallback=function(e){this.socket.onclose=e};t.setOnErrorCallback=function(e){this.socket.onerror=e};t.sendMessage=function(e){try{this.socket.send(e)}catch(t){console.log(t)}};t.closeSocket=function(){this.socket.close()};return t} 
